---
title: "Biodeposition analysis walk through"
format: html
editor: visual
---

## Summary:

This is a walk-through of the analysis to explain decisions we are considering and may make.

## Field size relationships (biodeposition animals)

File setup

```{r}
#| include: false
library(lme4)
library(ggplot2)
library(ggpubr)
library(data.table)
library(nlme)
setwd("~/GitHub/EAD-ASEB-Ssolidissima-OA/data")

bd <- fread("Biodeposition_experiment_summary - Biodeposition_results.csv")
```

```{r}
#| echo: false
bd<- bd[bd$Month =="September"|bd$Month =="April"|bd$Month =="June",]
bd$Site <- as.factor(bd$Site)
bd$Month <- as.factor(bd$Month)
bd$Month <- factor(bd$Month, levels=c("September", "April", "June"))
levels(bd$Month) <- c("Cohort 1 - Sep '22", "Cohort 2 - April '23", "Cohort 2 - June '23")

bd$Treatment <- as.factor(bd$Treatment)
bd$Treatment <- factor(bd$Treatment, levels=c("N", "S", "OUT"))
bd <- bd[bd$TPM>=.9,]

bd <- bd[bd$Treatment!="OUT",]
```

Note that in the following graph the relationship between DW and length is substantially different for the first cohort in Provincetown in September '22. Reproductive tissue was only \~0.5% of tissue weight for the largest cohort with the greatest dry weight in June '23 so reproduction cannot account for these differences in condition. Given these differences, does length or DW more consistently scale with feeding in both field and lab conditions?

```{r}
gg1 <- ggplot(data = bd, aes(x=Length, y=Dry.weight, color = Month))+
  geom_point(aes(shape=Treatment))+
  facet_wrap(~ Site)
gg1
```

## Field Biodeposition

First, let's look at OER and IER unscaled at each site. I'm pooling by treatment because treatment did not seem to have much of an effect, but biodeposition often differs by site and month

```{r}
gg1 <- ggplot(data = bd, aes(x=Dry.weight, y=OER, color = Month))+
  geom_point(aes(shape=Treatment))+
  facet_wrap(~paste(Site, Month))

gg1

gg1 <- ggplot(data = bd, aes(x=Dry.weight, y=IER, color = Month))+
  geom_point(aes(shape=Treatment))+
  facet_wrap(~ paste(Site, Month))

gg1


```

```{r}
gg1 <- ggplot(data = bd, aes(x=Length
                             , y=OER, color = Month))+
  geom_point(aes(shape=Treatment))+
  facet_wrap(~paste(Site, Month))

gg1

gg1 <- ggplot(data = bd, aes(x=Length
                             , y=IER, color = Month))+
  geom_point(aes(shape=Treatment))+
  facet_wrap(~ paste(Site, Month))

gg1
```

We initially used a size-scaling coefficient of 0.76 from gill size relationships that a student of Shannon's had collected (see below graphs). It seems that CR decreases with size

```{r}

gg1 <- ggplot(data = bd, aes(x=Dry.weight, y=CR
                             , color = Month))+
  geom_point(aes(shape=Treatment))+
    stat_smooth(
    method = 'nls',
    formula = y ~ A * x^B,
    method.args = list(start = c(A = 2.3, B = 2)),
    se = FALSE
  ) +
  facet_wrap(~paste(Site, Month))

gg1

gg1 <- ggplot(data = bd, aes(x=Length, y = CR
                             , color = Month))+
  geom_point(aes(shape=Treatment))+
  stat_smooth(
    method = 'nls',
    formula = y ~ A * x^B,
    method.args = list(start = c(A = 2.3, B = 2)),
    se = FALSE
  ) +
  facet_wrap(~ paste(Site, Month))

gg1

```

In fact, if we fit all CR data using the same exponent but different coefficients, we initially got an exponent of -0.47. However, it looks like the main negative relationship is in Eel Pond in June, where half of the clams were collected from outside the cages. So I reran, excluding these surfclams in the first couple of code chunks, and this seems to resolve the issue: bd \<- bd\[bd\$Treatment!="OUT",\]. Now the exponent is -.28.

```{r}
fit1 <- nlme::gnls(CR
                   ~ A*(Dry.weight)^B,
           params = list(A~paste(Site, Month)
                         -1, B~1), 
           data=bd,
           na.action = na.exclude,
           start = list(A=c(1,1,1,1,1,1
                            ), B = c(.3
                                     ) ))
summary(fit1)

gg1 <- ggplot(data = bd, aes(x=Dry.weight, y = CR
                             , color = Month))+
  geom_point(aes(shape=Treatment))+
  stat_smooth(
    method = 'nls',
    formula = y ~ A * x^-.29,
    method.args = list(start = c(A = 2.3)),
    se = FALSE
  ) +
  facet_wrap(~ paste(Site, Month))

gg1

gg1 <- ggplot(data = bd, aes(x=Length, y = CR
                             , color = Month))+
  geom_point(aes(shape=Treatment))+
  stat_smooth(
    method = 'nls',
    formula = y ~ A * x^-.29,
    method.args = list(start = c(A = 2.3)),
    se = FALSE
  ) +
  facet_wrap(~ paste(Site, Month))

gg1
```

Qualitatively this looks fine. There are no negative relationships. But, if we test a linear vs. an exponential relationship, it seems that the exponential relationship significantly wins.

```{r}
fit1 <- nlme::gnls(CR
                   ~ A*(Dry.weight)^B,
           params = list(A~paste(Site, Month)
                         -1, B~1), 
           data=bd,
           na.action = na.exclude,
           start = list(A=c(1,1,1,1,1,1
                            ), B = c(.3
                                     ) ))
summary(fit1)
fit2 <- nlme::gnls(CR
                   ~ A*(Dry.weight)+B,
           params = list(A~paste(Site, Month)
                         -1, B~1),
           data=bd,
           na.action = na.exclude,
           start = list(A=c(1,1,1,1,1,1
                            ),B = c(.3
                                     ) ))
summary(fit2)
AIC(fit1, fit2)
BIC(fit1, fit2)
```

I still don't think any of this is significant so I'm switching over to linear modeling because it's easier to do frequentist statistics with this method. Yes, this is not significant.

## Redoing the scaling with length

```{r}

bd$CR_LenScaling <- bd$CR*(bd$Dry.weight^.76)/((bd$Length/10)^2.0)

gg1 <- ggplot(data = bd, aes(x=Length, y = CR_LenScaling
                             , color = Month))+
  geom_point(aes(shape=Treatment))+
  stat_smooth(
    method = 'nls',
    formula = y ~ A * x^B,
    method.args = list(start = c(A = 2.3, B = 2)),
    se = FALSE
  ) +
  facet_wrap(~ paste(Site, Month))

gg1
```
